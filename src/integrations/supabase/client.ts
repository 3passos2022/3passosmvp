// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { ENV } from '@/env';

// Obtém as variáveis de ambiente
const supabaseUrl = ENV.SUPABASE_URL;
const supabaseAnonKey = ENV.SUPABASE_ANON_KEY;

// Verifica se as variáveis de ambiente estão definidas
if (!supabaseUrl || !supabaseAnonKey) {
  console.error('Variáveis de ambiente do Supabase não encontradas');
}

export const supabase = createClient<Database>(
  supabaseUrl,
  supabaseAnonKey,
  {
    auth: {
      persistSession: true,
      storageKey: '3passos-auth',
      storage: typeof window !== 'undefined' ? window.localStorage : undefined,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      flowType: 'pkce',
    },
    global: {
      headers: {
        'x-application-name': '3passos',
        'x-frame-options': 'DENY',
        'x-content-type-options': 'nosniff',
        'strict-transport-security': 'max-age=31536000; includeSubDomains',
        'x-xss-protection': '1; mode=block'
      }
    },
    db: {
      schema: 'public'
    }
  }
);

// Set site URL for Supabase redirects
if (typeof window !== 'undefined') {
  // Get existing session from storage
  const existingToken = localStorage.getItem('sb-jezfwtknzraaykkjjaaf-auth-token');
  const existingRefreshToken = localStorage.getItem('sb-jezfwtknzraaykkjjaaf-auth-refresh-token');
  
  if (existingToken && existingRefreshToken) {
    try {
      const parsedToken = JSON.parse(existingToken);
      const parsedRefreshToken = JSON.parse(existingRefreshToken);
      
      // Use setSession in newer versions of Supabase instead of setAuth
      supabase.auth.setSession({
        access_token: parsedToken,
        refresh_token: parsedRefreshToken,
      }).catch(err => {
        if (typeof window !== 'undefined') {
          console.error('Error setting session:', err);
        }
      });
    } catch (error) {
      if (typeof window !== 'undefined') {
        console.error('Error parsing stored tokens:', error);
      }
    }
  }
}
